```{r}
library(tidyverse)
library(cancensus)
library(knitr)
library(readr)
library(sf)
library(geojsonsf)
```

### Loading census using API key
#### First we load our api key and create our vector of columns we would like to extract
```{r}
load("API_KEY.rda")

options(cancensus.api_key = api_key)
options(cancensus.cache_path = "cache")

vectors <- c("v_CA21_1",
             "v_CA21_6",
             "v_CA21_449",
             "v_CA21_1040",
             "v_CA21_1085",
             "v_CA21_905")
```
#### Get the dataset and save to file. Clear api key out of global env. THIS DATA CONTAINS SF INFO FOR CENSUS!!!!
```{r}
census_data <- get_census(dataset = "CA21",
                     regions = list(CMA="59933"),
                     vectors = vectors,
                     labels = "detailed",
                     geo_format = "sf",
                     level = "DA")

can_api_key <- ""
save(census_data, file = "data/census.rda")
```

```{r}
head(census_data)
```

### (note)Then we have to load other data, transform , add sf info, then merge into dataset and add comparison functions


### Loading other datasets , renaming and standardizing columns

```{r}
food <- read_delim("data/vancouver_food_programs.csv", delim=';') %>% 
  select("Program Name", "Program Status", "Meal Cost", "Local Areas", "Latitude", "Longitude") %>%
  drop_na("Latitude", "Longitude")

colnames(food) <- gsub("\\.", "_", tolower(make.names(colnames(food))))
food <- food %>%
  st_as_sf(coords = c("latitude", "longitude"), crs = 4326)
```


```{r}
food_data <- st_read("data/free-and-low-cost-food-programs.shp")  %>%
  select("program_nam", "program_sta", "meal_cost", "local_areas", "latitude", "longitude", "geometry") %>%
  drop_na("latitude", "longitude") %>%
  # set to wgs 84 as per can census
  st_set_crs(4326)

head(food_data)
```
```{r}
crime <- read_csv("data/crime_data_all_neighborhoods.csv")
colnames(crime) <- tolower(make.names(colnames(crime)))

head(crime)

# # create lat/long vector for crime data
# crime_data <- crime %>%
#   mutate(geom = paste0(x, ", ", y))
# 
# # now we mutate crime data to add shapefile information
# # set to wgs 84 as per can census
# crime_data <- crime_data %>%
#   st_as_sf(coords = c("x", "y"), crs = 4326)
# 
# head(crime_data)
```
### Shapefile distance calculations
```{r}

census_geom <- st_geometry(census_data)
census_centroids <- st_centroid(census_geom)

intersections_food <- st_intersects(census_data, food_data, sparse = FALSE)
intersections_food_500 <- st_is_within_distance(census_data, food_data, sparse = FALSE, dist = 500)
food_contained <- rowSums(intersections_food, dims = 1)
food_within_500 <- rowSums(intersections_food_500, dims = 1)

mean(food_within_500)

```
```{r}
st_read(crime_data)

intersections_crime <- st_intersects(census_data, crime_data, sparse = FALSE)
intersections_crime_500 <- st_is_within_distance(census_data, crime_data, sparse = FALSE, dist = 500)
crime_contained <- rowSums(intersections_crime, dims = 1)
crime_within_500 <- rowSums(intersections_crime_500, dims = 1)


mean(crime_contained)
```
```{r}
# CRIME LOADING NOT WORKING!!!

crime_map <- ggplot() +
  geom_sf(data = crime_data, aes(color = type)) +  
  theme_minimal() +
  labs(title = "Crime data mapping",
       fill = "Legend", 
       color = "Crime Type") +
  theme(legend.position = "bottom")

food_map <- ggplot() +
  geom_sf(data = food_data, color = "blue") +  # Specify fill color or variable if needed
  theme_minimal() +
  labs(title = "Food center mapping")

food_no_sf_map <- ggplot() +
  geom_sf(data = food$geometry, color = "yellow") +  # Specify fill color or variable if needed
  theme_minimal() +
  labs(title = "Food center NO SF mapping")

crime_map
food_map
food_no_sf_map
```
```{r}
#stackexchange solution credit

# Get bounding box for food_data
bbox_food <- st_bbox(food_data)

# Get bounding box for crime_data
bbox_crime <- st_bbox(crime_data)

# Print the bounding boxes
print(bbox_food)
print(bbox_crime)

# EXtract bounds
# For food_data
min_x_food <- bbox_food["xmin"]
max_x_food <- bbox_food["xmax"]
min_y_food <- bbox_food["ymin"]
max_y_food <- bbox_food["ymax"]

# For crime_data
min_x_crime <- bbox_crime["xmin"]
max_x_crime <- bbox_crime["xmax"]
min_y_crime <- bbox_crime["ymin"]
max_y_crime <- bbox_crime["ymax"]

```
```{r}

# Get bounding box values for plotting limits
bbox_food <- st_bbox(food_data)
bbox_crime <- st_bbox(crime_data)

# Set plotting limits based on the bounding boxes
ggplot() +
  geom_sf(data = food_data, aes(fill = "Food Programs"), color = "black") + 
  geom_sf(data = crime_data, aes(color = type), size = 1) + 
  coord_sf(xlim = c(bbox_food["xmin"], bbox_food["xmax"]), 
           ylim = c(bbox_food["ymin"], bbox_food["ymax"])) + 
  labs(title = "Food Programs and Crime Data") +
  theme_minimal() +
  theme(legend.position = "bottom")


```
```{r}
bbox_crime <- st_bbox(crime_data)
print(bbox_crime)
```
```{r}
ggplot() +
  geom_sf(data = food_data, aes(fill = "Food Programs"), color = "black") + 
  geom_sf(data = crime_data, aes(color = type), size = 1) + 
  coord_sf() +  # Do not set xlim and ylim
  labs(title = "Food Programs and Crime Data") +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# Check a summary of the coordinates of crime_data
print(head(st_coordinates(crime_data)))

```



